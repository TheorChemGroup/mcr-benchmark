# Ringo benchmark workflow on MacroModel testset

## How to reproduce our benchmark?

### Prepare testset

We use MacroModel testset for our benchmark (see [original paper](https://doi.org/10.1021/ci5001696)). However, there are issues with the structures provided in SI of the original paper (the main concern is the placement of hydrogen atoms). Thus, we implemented a separate workflow for preparation of test macrocycles [in a separate repository](https://gitlab.com/knvvv/macromodel-testset). Moreover, it is more reasonable to start conformational searches from random conformers (not the experimental ones), thus, a separate part of [the preparation workflow](https://gitlab.com/knvvv/macromodel-testset) is dedicated to randomizing conformations of test macrocycles. As a result, this workflow generates 150 structures in sdf-format that are stored in a `start_conformers` directory.

As soon as starting conformers are generated, json-files of testing data can be created (note that the path to `start_conformers` directory has to be set in both scripts):

```
python create_small_testset.py # Generates 'small_testcases.json'
python create_testset.py # Generates 'testcases.json'
```

### Prepare environments

Double-check that all `exec_*` scripts contain valid paths to CREST, XTB and SCHRODINGER directories. Also, make these scripts executable:

```
chmod +x exec_*
```

Scripts of this workflow use three conda environments and two python variants (usual interpreter and Intel Python). Two envs for usual interpreter can be reproduced from YAML files:

```
conda env create -f gnu_env.yml -n full
conda env create -f rpython_env.yml -n rpyenv
```

For better performance we sometimes use intelpython, however, this environment cannot be automatically reproduced from yaml-file (`intel_env.yml`). If it is desired, one can create this env by hand to have all the key packages of `full` env (pandas, rdkit, etc.) 

Additionally, all two (or three including intel) environments need to have `pyxyz` and `ringo` installed. To install them, follow README files at corresponding repositories of [pyxyz](https://gitlab.com/knvvv/pyxyz) and [ringo](https://gitlab.com/knvvv/ringo) - these libraries can either be built from source or downloaded as prebuilt binaries.

When all two (three) environments have been created, add commands for their activation in the `environments.py` script (the corresponding entry has to be uncommented if intelpython is used).

### Execute conformational searches

Record isomorphism counts for more efficient RMSD filtering:

```
python compute_niso.py
```

Execute conformational searches with all methods:

```
python run_ringo.py
python run_rdkit.py
python run_mtd.py
python run_crest.py # Must be executed twice: DO_GENCROSSING_FAILED=False and DO_GENCROSSING_FAILED=True
python run_mmbasic.py
python run_mmring.py
```

### Conformer optimization and post-processing

Specify the value of `NPROC` variable (number of available threads) at the beginning of `optimize.py`

```
python optimize.py
```

This script does several things:

1. Looks for conformational ensembles - xyz-files `{method}_conformers/{molname}_{method}.xyz`, optimizes them using RDKit and stores optimized ensembles in `optimized_conformers/{molname}_{method}.xyz`. Undesired topology changes and optimization fails are recorded if they occur.

2. Performs RMSD filtering of optimized ensembles and marks all duplicate conformers. Ensembles with these marks are stores in `filtered_conformers`.

3. Performs single-point MMFF calculations for all conformers in `filtered_conformers` directory and saves the same ensembles into `lower_conformers` directory with energy values as additional flags to each conformer.

4. Parses ensembles at `lower_conformers` and marks all conformers whose energy is 15 kcal/mol or higher compared to the lowest energy conformer across all ensembles generated by tested methods. The marked ensembles are saved into the same directory `lower_conformers` overwriting the files generated on the step 4.

5. Parses the ensembles at `lower_conformers`, `{method}_df.csv` and also `cpuload_{method}.json` to summarize conformer counts, timings and CPU usage in a single dataframe. Adds self-explanatory keys `n_duplicates`, `n_failed_opts`, `n_failed_topo`, `n_higher_unique`, `n_lower_unique`, `thread_avg`.

The main result of the script `optimize.py` is the file `benchmark_stats.csv` that will be used for timing analysis and, also, the marked conformational ensembles `lower_conformers/*.xyz` that will later be used for diversity analysis.

### Plot timing benchmarks and generate CSVs with testset overview and timings

`analyze_timings.ipynb` contains all the necessary code for plotting timing benchmarks, generating CSV with testset overview and CSV with timings.

### Perform diversity analysis and generate PDF report

Specify the value of `NPROC` variable (number of available threads) at the beginning of `diversity_analysis.py`

```
python diversity_analysis.py
```

At the heart of `diversity_analysis.py` workflow is a unique way of computing RMSD of macrocycles. To measure diversity of conformational ensembles, we compute separate RMSD matrices for atoms of all cyclic parts of the molecule and, then, it computes element-wise maximum of matrix elements, i.e. if all cyclic fragments are similar, then such RMSD is close to zero, but, if at least one cyclic part has different conformation, the overall RMSD will be significant. During diversity analysis, the only king of RMSD that will be considered is this cyclic RMSD variant.

`diversity_analysis.py` distinguishes three types of conformers according to their importance for conformational ensemble quality:

1. Low-energy conformers - the conformers with energy <15 kcal/mol relatively to the most stable conformers in the ensemble. These conformers are of immediate interest for conformational sampling.

2. Perspective conformers are high-energy conformers (>15 kcal/mol) that have RMSD < 0.5 A with some low-energy conformer. As the name suggests, these structures feature a perspective confomation of their macrocyclic framework despite high-energy of the complete conformer. Perspective conformers are also important targets of macrocyclic conformational sampling because their non-cyclic dihedrals can be modified to lower their energy (as suggested by their small RMSD with some low-energy conformers), which is a significantly easier task compared to macrocyclic sampling.

3. Unperspective conformers - high-energy conformers (>15 kcal/mol) that do not have RMSD < 0.5 A with any of the low-energy conformers. This means that such conformers feature unfavorable configurations of macrocyclic framework which renders them undesired in macrocyclic conformational sampling.

`diversity_analysis.py` performs the following steps:

1. Unite conformer ensembles generated by all tested methods into a single file removing all unperspective conformers.

2. Compute RMSD matrices for united conformational ensembles.

3. Bruteforce multiple eps values for DBSCAN and choose the one corresponding to the optimal clustering of conformational ensemble of each test molecule. If for some molecules a good enough clustering quality could not be achieved, conformational ensembles of these molecules is considered to be too sparse to be analyzed - such molecules are not considered further.

4. Compute 2D embedding of conformers using TSNE. For each cluster select a medoid (the conformer closest to the cluster center).

5. Generate auxiliary energy plots and clustering quality plots.

6. For each cluster, find methods that have successfully located it. Plot 2D coordinates (obtained earlier with TSNE) of each conformer and color them according to status of the cluster (found only Ringo/only alternative/both + lone conformers).

As a result, a PDF with final report `filtered_ensemble_diversity/final_report.pdf` will be generated.

## Repository layout

| ringo-benchmark/ |  |
| -------- | -------- |
| *Directories* | |
| `conda_environments/` | Specifications of conda environments |
| `chemscripts/` | Utility scripts |
| `*_conformers/` | Conformational ensembles generated by run_*.py scripts (* are the names of methods) |
| `*_temp/` | Temporary files generated by some of run_*.py scripts during conformational sampling |
| `optimized_conformers/` | Conformer ensembles after RDKit optimization (generated by optimize.py) |
| `filtered_conformers/` | Conformer ensembles with marked duplicates (generated by optimize.py) |
| `lower_conformers/` | Conformer ensembles with marked duplicates and high-energy conformers (generated by optimize.py) |
| `filtered_ensemble_diversity/` | Files related to diversity analysis (processed by diversity_analysis.py) |
| *Testset-related files* |  |
| `create_testset.py` | Assemble testset info for Ringo, MTD and RDKit (all 150 molecules) |
| `create_small_testset.py` | Assemble testset info for CREST and MacroModel (10 pre-selected molecules) |
| `testcases.json` | Serialized mapping from a name of test molecule to an actual SDF file in `start_conformers` directory (generated by create_testset.py) |
| `small_testcases.json` | Similar serialized mapping for smaller 10 testset (generated by create_small_testset.py) |
| `check_testset.zip` | Backup of the entire testset (generated by create_testset.py) |
| `check_small_testset.zip` | Backup of the smaller testset (generated by create_small_testset.py) |
| *Conformational search-related* |  |
| `run_*.py` | Driver scripts of conformational search methods |
| `exec_*` | Shell scripts for external calls of XTB, CREST and MacroModel (used by run_*.py) |
| `mmgeneral_setup` | Template of MacroModel (torsional + low-mode sampling) input file |
| `*_df.csv` | Dataframes with timings and conformers counts created by corresponding run_*.py scripts |
| `cpuload_*.json` | CPU load data recorded for CREST and MacroModel for later correction of timings with the number of threads used |
| *Postprocessing-related* |  |
| `optimize.py` | Workflow for ensembles postprocessing |
| `optimization_stats.json` | Conformer status summary produced by optimize.py (number of conformers in every ensemble with given status) |
| `benchmark_stats.csv` | Generated by optimize.py. Contains conformer counts, timings and CPU usage data |
| `analyze_timings.ipynb` | Jupyter Notebook for plotting generation rates and creating CSV with testset overview and CSV with timing benchmarks |
| `*_energy_timings.svg` | Generation rates plots produced by analyze_timings.ipynb |
| `testset_overview.csv` | Basic information on MacroModel testset generated by analyze_timings.ipynb (for SI of the paper) |
| `timings_results.csv` | Timing benchmarks generated by analyze_timings.ipynb (for SI of the paper) |
| `diversity_analysis.py` | Workflow for diversity analysis and generating the PDF for SI |
| *Auxiliary files* |  |
| `compute_niso.py` | Generate isomorphism counts to be used by Ringo for efficient RMSD filtering |
| `niso_timings.json` | Isomorphism counts generated by compute_niso.py |
| `environments.py` | Utility functions and, most importantly, stores commands for activating conda envs |
| `arial.ttf` | Font for final PDF report (used by diversity_analysis.py) |
| `charges.py` | Records of all charged test molecules |

| filtered_ensemble_diversity/ |  |
| -------- | -------- |
| *Directories* |  |
| `total_confensembles/` | total ensembles for diversity analysis (with unperspective conformers removed) |
| `rmsd_matrices/` | RMSD matrices for total ensembles |
| `clustering_options/` | Clustering labels and reachability plots for all checked eps values |
| `best_clusterings/` | Reachability plots, clustering labels and RMSD submatrices for cluster medoids for the chosen clusterings  |
| `embeddings/` | 2D coordinates of all conformers for embeddings obtained from full RMSD matrices |
| `clustering_evaluation/` | Plots for evaluation of ensemble clustering, embedding, etc. |
| `energy_plots/` | Energy summaries for ensembles generated by various methods |
| `diversity_results/` | Diversity comparison of ensembles generated by various methods |
| *Files* | |
| `final_report.pdf` | Combined figures from directories `best_clusterings`, `clustering_evaluation`, `energy_plots`, `diversity_results` |
